#!/bin/bash

echo -e "\n\e[1;33mSetup incul template...\e[0m"

# Prompt for username and password
read -p "Enter username (default: incul): " username
username=${username:-incul}

read -sp "Enter password (default: incul): " password
password=${password:-incul}
echo

read -p "Enter template name (default: incul-template): " template_name
template_name=${template_name:-incul-template}

# TO BE IMPLEMENTED, neeed a file for each possible package manager (apt, pacman, etc)
read -p "Enter icus image (default: debian/12): TO BE IMPLEMENTED" icus_image 
icus_image=${icus_image:-debian/12}

# Add the provided or default values to the start of the existing config.sh file
temp_file=$(mktemp)
cat <<EOL > $temp_file
# username and password used to connect to containers

username="$username"

password="$password"

template_name="$template_name"

EOL
cat /etc/inculs-manager/config.sh >> $temp_file
mv $temp_file /etc/inculs-manager/"$template_name"-config.sh

# launch incus
incus admin init --minimal

incus launch images:debian/12 $template_name

#copy files to container
incus file push /etc/inculs-manager/"$template_name"-config.sh incul-template/root/config.sh

incus file push /usr/bin/update-inculs-sources incul-template/root/

incus file push /usr/bin/incul-create-user incul-template/root/

#make executable
incus exec incul-template -- chmod +x update-inculs-sources

incus exec incul-template -- chmod +x incul-create-user

#update container
incus exec incul-template -- /root/update-inculs-sources

incus exec incul-template -- apt-get update

# Install packages
incus exec incul-template -- apt-get install thunar xfce4-terminal xfce4-notifyd xfwm4 openssh-server xpra openssl

#create sudo user
incus exec incul-template -- /root/incul-create-user

echo -e "\n\e[1;33mTemplate creation complete...\e[0m"
